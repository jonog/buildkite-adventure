#!/usr/bin/env ruby

require 'yaml'
require 'file/temp'

class Step
  attr_reader :page, :actions

  def initialize(page, actions)
    @page = page
    @actions = actions
  end
end

def to_buildkite_pipeline(step)
  {
    "steps" => [
      {
        "block" => ":point_right:",
        "prompt" => "Choose the next action!",
        "fields" => [ { "text" => "Yes", "key" => "decision" } ]
      },
      {
        "command" => "./adventure",
        "label" => ":book:"
      }
    ]
  }
end

s = Step.new("welcome", [ "Go Left", "Go Right" ])

# Show the page of the adventure
puts `pages/#{s.page}.sh`

# Upload new steps to BK to continue the adventure
tempfile = File::Temp.new(false, 'pipeline.yml')
tempfile.write(to_buildkite_pipeline(s).to_yaml)
tempfile.close

`buildkite-agent pipeline upload #{tempfile.path} &2> /dev/null`
