#!/usr/bin/env ruby

require 'open3'
require 'yaml'
require 'file/temp'

class Step
  attr_reader :page, :actions

  def initialize(page, actions)
    @page = page
    @actions = actions
  end
end

def to_buildkite_pipeline(step)
  {
    "steps" => [
      {
        "block" => ":point_right:",
        "prompt" => "Choose the next action!",
        "fields" => [ { "text" => "Yes", "key" => "decision" } ]
      },
      {
        "command" => "adventure",
        "label" => ":book:"
      }
    ]
  }
end

s = Step.new("welcome", [ "Go Left", "Go Right" ])

# Show the page of the adventure
puts `pages/#{s.page}.sh`

# Upload new steps to BK to continue the adventure
upload_input = to_buildkite_pipeline(s).to_yaml
upload_output, upload_error, upload_status = Open3.capture3("buildkite-agent", "pipeline", "upload", stdin_data: upload_input)

unless upload_status.success?
  puts upload_error
end
